// ext/core/rules/SimpleRule.js - –ü—Ä–∞–≤–∏–ª–æ "–ü—Ä–æ—Å—Ç–æ" (—Ä–∞–±–æ—Ç–∞ —Å –Ω–∏–∂–Ω–∏–º–∏ –∫–æ—Å—Ç–æ—á–∫–∞–º–∏ 0-4)

import { BaseRule } from './BaseRule.js';

/**
 * SimpleRule - –ø—Ä–∞–≤–∏–ª–æ "–ü—Ä–æ—Å—Ç–æ"
 * –†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å –Ω–∏–∂–Ω–∏–º–∏ –∫–æ—Å—Ç–æ—á–∫–∞–º–∏ –∞–±–∞–∫—É—Å–∞ (0-4)
 * –ë–ï–ó –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤–µ—Ä—Ö–Ω–µ–π –∫–æ—Å—Ç–æ—á–∫–∏ (¬±5 –∑–∞–ø—Ä–µ—â–µ–Ω—ã)
 * 
 * –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:
 * - –ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ (+1, +2, +3, +4)
 * - –í—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è: 0-4
 * - –ï—Å–ª–∏ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ = 0, —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
 * - –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: 0-4
 * - –ù–æ–ª—å –ù–ï –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –≤ –Ω–∞—á–∞–ª–µ –ø—Ä–∏–º–µ—Ä–∞
 */
export class SimpleRule extends BaseRule {
  constructor(config = {}) {
    super(config);
    
    this.name = "–ü—Ä–æ—Å—Ç–æ";
    this.description = "–†–∞–±–æ—Ç–∞ —Ç–æ–ª—å–∫–æ —Å –Ω–∏–∂–Ω–∏–º–∏ –∫–æ—Å—Ç–æ—á–∫–∞–º–∏ (0-4), –±–µ–∑ ¬±5";
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞ "–ü—Ä–æ—Å—Ç–æ"
    this.config = {
      minState: 0,
      maxState: 4,
      minSteps: 1,
      maxSteps: 3,
      allowedActions: [1, 2, 3, 4, -1, -2, -3, -4],
      forbiddenActions: [5, -5], // –ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –≤–µ—Ä—Ö–Ω–µ–π –∫–æ—Å—Ç–æ—á–∫–æ–π
      firstActionMustBePositive: true, // –ö–†–ò–¢–ò–ß–ù–û: –ø–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –≤—Å–µ–≥–¥–∞ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
      ...config
    };
  }

  /**
   * –ü–æ–ª—É—á–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è —Å —É—á—ë—Ç–æ–º –í–°–ï–• –ø—Ä–∞–≤–∏–ª
   * @param {number} currentState - –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   * @param {boolean} isFirstAction - –ü–µ—Ä–≤–æ–µ –ª–∏ —ç—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –≤ —Ü–µ–ø–æ—á–∫–µ
   * @returns {number[]} - –ú–∞—Å—Å–∏–≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
   */
  getAvailableActions(currentState, isFirstAction = false) {
    let actions = super.getAvailableActions(currentState);
    
    // –ü–†–ê–í–ò–õ–û 1: –ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –í–°–ï–ì–î–ê –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
    if (isFirstAction) {
      actions = actions.filter(action => action > 0);
      console.log(`üéØ –ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è ${currentState}):`, actions);
      return actions;
    }
    
    // –ü–†–ê–í–ò–õ–û 2: –ï—Å–ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ = 0, —Å–ª–µ–¥—É—é—â–µ–µ –¥–µ–π—Å—Ç–≤–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ
    if (currentState === 0) {
      actions = actions.filter(action => action > 0);
      console.log(`‚ö†Ô∏è –°–æ—Å—Ç–æ—è–Ω–∏–µ 0 ‚Üí —Ç–æ–ª—å–∫–æ –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:`, actions);
      return actions;
    }
    
    console.log(`‚úÖ –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è ${currentState}:`, actions);
    return actions;
  }

  /**
   * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
   * –î–ª—è –ø—Ä–∞–≤–∏–ª–∞ "–ü—Ä–æ—Å—Ç–æ" –Ω–∞—á–∞–ª–æ –≤—Å–µ–≥–¥–∞ 0 (–ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç—Å—è)
   * @returns {number}
   */
  generateStartState() {
    return 0; // –í—Å–µ–≥–¥–∞ –Ω–∞—á–∏–Ω–∞–µ–º —Å 0
  }

  /**
   * –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø—Ä–∏–º–µ—Ä–∞
   * @param {Object} example - { start, steps, answer }
   * @returns {Object} - { isValid, errors }
   */
  validateExample(example) {
    const errors = [];
    let currentState = example.start;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 1: –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0
    if (currentState !== 0) {
      errors.push(`–ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0, –ø–æ–ª—É—á–µ–Ω–æ ${currentState}`);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 2: –ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
    if (example.steps.length > 0) {
      const firstStep = example.steps[0];
      if (firstStep.action <= 0) {
        errors.push(`–ü–µ—Ä–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º, –ø–æ–ª—É—á–µ–Ω–æ ${firstStep.action}`);
      }
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 3: –í—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 0-4
    example.steps.forEach((step, index) => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
      if (!this.isValidAction(currentState, step.action)) {
        errors.push(`–®–∞–≥ ${index + 1}: –¥–µ–π—Å—Ç–≤–∏–µ ${step.action} –Ω–µ–¥–æ–ø—É—Å—Ç–∏–º–æ –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è ${currentState}`);
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∏–ª–æ: –µ—Å–ª–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ = 0, –¥–µ–π—Å—Ç–≤–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—ã–º
      if (currentState === 0 && step.action < 0) {
        errors.push(`–®–∞–≥ ${index + 1}: –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è 0 –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ ${step.action}`);
      }

      // –ü—Ä–∏–º–µ–Ω—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ
      const newState = this.applyAction(currentState, step.action);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä–∞–Ω–∏—Ü—ã
      if (!this.isValidState(newState)) {
        errors.push(`–®–∞–≥ ${index + 1}: —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${newState} –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã (0-4)`);
      }

      currentState = newState;
    });

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 4: –§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 0-4
    if (!this.isValidState(example.answer)) {
      errors.push(`–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${example.answer} –≤—ã—Ö–æ–¥–∏—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã (0-4)`);
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ 5: –†–∞—Å—á—ë—Ç–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ = —Ñ–∏–Ω–∞–ª—å–Ω–æ–º—É
    if (example.answer !== currentState) {
      errors.push(`–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ ${example.answer} –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å —Ä–∞—Å—á—ë—Ç–Ω—ã–º ${currentState}`);
    }

    return {
      isValid: errors.length === 0,
      errors: errors
    };
  }
}

